# Express框架

### 1. Express使用

**安装Express**

Express是npm的包，可以通过npm安装

```shell
# 1. 先创建一个项目
mkdir 08_体验
# 2. npm初始化
npm init
# 3. 安装express包
npm i express
```

**基本使用**

```js
// 导入express
const express = require('express')

// 创建应用对象
const app = express()

app.get('/request', (req, res) => {
    console.log(req.method)
    console.log(req.url)
    console.log(req.httpVersion)
    console.log(req.headers)

    console.log(req.query)
    console.log(req.get('host'))
    res.end('request')
})

app.get('/response', (req, res) => {
    // 1.express中设置响应的方式兼容HTTP模块的方式
    // res.statusCode = 404
    // res.statusMessage = 'xxx'
    // res.setHeader('abc', 'xyz')
    // res.write('响应体')
    // res.end('xxx')

    // 2.exprees的设置方式
    // res.status(500)
    // res.set('xxx', 'yyy')// 设置响应头
    // res.send('中文响应不乱码') // 设置响应体
    // 连贯操作
    // res.status(404).set('xxx', 'yyy').send('页面找不到了')

    // 3.其他响应
    // res.redirect('https://baidu.com') // 重定向
    // res.download('./package.json') // 下载响应
    // res.json({a:"1"}) // json响应
    res.sendFile(__dirname + '/package.json') // 响应文件内容，这里的文件地址必须是绝对路径
})

app.get('/:id.html', (req, res) => {
    res.send('商品详情，商品ID为：' + req.params.id)
})

// 这个要放在最后
app.all('*', (req, res) => {
    res.end('<h1>404 Not Found</h1>')
})

// 监听端口 启动服务
app.listen(3000, () => {
    console.log('服务已启动，监听端口是3000')
})
```

**中间件**

- 全局中间件

```js
// 导入包
const express = require('express')
const fs = require('fs')
const path = require('path')

const app = express()

// 记录访问信息的中间件函数
function recordMiddleware(req, res, next) {
    const {url, ip} = req
    fs.appendFileSync(path.resolve(__dirname, './access.log'), `${url} ${ip}\r\n`)
    // 调用next
    next()
}

// 使用中间件函数
app.use(recordMiddleware)


//创建路由
app.get('/home', (req, res) => {
    res.send('前台首页');
});

app.get('/admin', (req, res) => {
    res.send('后台首页');
});

app.all('*',(req, res) => {
    res.send('<h1>404 Not Found</h1>')
})

//监听端口, 启动服务
app.listen(3000, () => {
    console.log('服务已经启动, 端口 3000 正在监听中....')
})
```

- 路由中间件

```js
/**
 * 创建一个路由中间件，检验需要携带code且等于521，否则提示错误
 */
const express = require('express')

// 创建app
const app = express()

// 定义中间件函数
function checkCodeMiddleware(req, res, next) {
    if (req.query.code === '521') {
        next()
    } else {
        res.send('有内鬼，停止交易')
    }
}

//后台
app.get('/admin', checkCodeMiddleware, (req, res) => {
    res.send('后台首页');
});

//后台设置
app.get('/setting', checkCodeMiddleware, (req, res) => {
    res.send('设置页面');
});

app.all('*',(req, res) => {
    res.send('<h1>404 Not Found</h1>')
})

//监听端口, 启动服务
app.listen(3000, () => {
    console.log('服务已经启动, 端口 3000 正在监听中....')
})
```

- 静态资源中间件

```js
//导入 express
const express = require('express');

//创建应用对象
const app = express();

//创建路由
app.get('/', (req, res) => {
  res.send('我才是首页~~~');
});

//静态资源中间件设置
// 范文时不要加public了，http://127.0.0.1:3000/index.html
app.use(express.static(__dirname + '/public'));


//监听端口, 启动服务
app.listen(3000, () => {
  console.log('服务已经启动, 端口 3000 正在监听中....')
})
```

- 解析请求体的中间件

```js
/**
 * GET /login 显示表单网页
 * POST /login 获取用户提交的数据
 */
const express = require('express')
const bodyParser = require('body-parser')

const app = express()

app.get('/login', (req, res) => {
    // 响应HTML文件内容
    res.sendFile(__dirname + '/11_form.html')
})

// 定义一个中间件
// 处理 queryString 格式请求体
const urlencodedParser = bodyParser.urlencoded({ extended: false})
// 处理 json 格式请求体
// const urlencodedParser = bodyParser.json()

app.post('/login', urlencodedParser, (req, res) => {
    console.log(req.body)
    res.send('获取用户的数据')
})

app.listen('3000', () => {
    console.log('服务启动成功，监听：3000端口')
})
```

**路由模块化**

```js
/**
 * 针对 /admin /setting
 */
const express = require('express')
const homeRouter = require('./routers/homeRouter')
const adminRouter = require('./routers/adminRouter')

const app = express()
app.use(homeRouter)
app.use(adminRouter)

app.all('*', (req, res) => {
    res.send('<h1>404 Not Found</h1>')
})

app.listen('3000', () => {
    console.log('启动服务成功，监听端口：3000')
})

// homeRouter.js
const express = require('express')

const router = express.Router()

router.get('/home', (req, res) => {
    res.send('前台首页')
})

router.get('/search', (req, res) => {
    res.send('内容搜索')
})

module.exports = router

// adminRouter
const express = require('express')

const router = express.Router()

router.get('/admin', (req, res) => {
    res.send('后台首页')
})

router.get('/setting', (req, res) => {
    res.send('设置页面')
})

module.exports = router
```


