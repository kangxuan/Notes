# Key

redis是key-value数据库，类型是针对value的，key都是字符串。key是区分大小写，而命令不区分大小写。

**key的常用操作**

| 操作                   | 含义                             | 返回值                       |
| -------------------- | ------------------------------ | ------------------------- |
| keys *               | 查看当前库所有的key，谨慎使用               | 为空返回(empty array)         |
| exists key           | 判断key是否存在                      | 存在返回1，反之0                 |
| type key1            | 判断key是什么类型                     | string、list等等，key不存在为none |
| del key1             | 删除指定的key                       | 成功返回1，失败返回0               |
| unlink key1          | 非阻塞删除，仅从keyspace中删除，真正的删除会异步进行 | 成功返回1，失败返回0               |
| ttl key1             | 查看还有多少秒过期                      | -1表示用不过期、-2表示已过期或被删除      |
| expire key1 秒数       | 为指定的key设置秒过期时间                 | 成功返回1，失败返回0               |
| pexpire key1 毫秒      | 为指定的key设置毫秒过期时间                | 成功返回1，失败返回0               |
| expireat key1 时间戳    | 为指定的key设置秒时间戳过期时间              | 成功返回1，失败返回0               |
| pexpireat key1 毫秒时间戳 | 为指定的key设置毫秒时间戳过期时间             | 成功返回1，失败返回0               |
| move key dbindex     | 将key移动到指定的数据库db中               | 成功返回1，失败返回0               |
| select dbindex       | 切换数据库                          | 成功返回1，失败返回0               |
| dbsize               | 查看当前数据库key的数量                  | key的数量                    |
| flushdb              | 清空当前库                          |                           |
| flushall             | 清空全部库                          |                           |

# Help帮助命令

redis内置的帮助文档命令

```shell
# help @类型
127.0.0.1:6379> help @string
```

# String

string是redis最基本的类型，一个key对应一个value。String类型是二进制安全的，意思是redis的string类型可以包含任意数据。字符串value最多可以是512M。

**命令场景**

- 最常用的

```shell
# 最简单的设置和获取，永不过期
127.0.0.1:6379> set key helloworld
OK
127.0.0.1:6379> get key
"helloworld"

# set时设置过期时间，是一个原子操作
127.0.0.1:6379> set key1 helloworld1 ex 60
OK
127.0.0.1:6379> ttl key1
(integer) 57
# set时保持之前的过期时间
127.0.0.1:6379> set key1 helloworld1_update keepttl
OK
127.0.0.1:6379> ttl key1
```

SET的参数

```shell
SET key value [NX | XX] [GET] [EX seconds | PX milliseconds |
  EXAT unix-time-seconds | PXAT unix-time-milliseconds | KEEPTTL]

# NX 当key不存在时设置
# XX 当key已存在时设置
# GET 返回key原本的值，不存在时返回nil
127.0.0.1:6379> set key1 helloworld1_update GET
"helloworld1"
127.0.0.1:6379> get key1
"helloworld1_update"
# EX seconds 以秒为单位设置过期时间
# PX milliseconds 以毫秒为单位设置过期时间
# EXAT unix-time-seconds 以秒时间戳设置过期时间
# PXAT unix-time-milliseconds 以毫秒时间戳设置过期时间
# KEEPTTL 保持之前的过期时间，但对于已过期或不存在的key，设置后是永久
```

- 同时设置/获取多个

```shell
# mset key value [key value ...]
127.0.0.1:6379> mset key1 aa key2 bb key3 cc
OK
127.0.0.1:6379> mget key1 key2 key3
1) "aa"
2) "bb"
3) "cc"

# msetnx key value [key value ...] 当key不存在时才设置
127.0.0.1:6379> msetnx key1 xx key2 yy key3 zz
(integer) 0
127.0.0.1:6379> msetnx key4 xx key5 yy key6 zz
(integer) 1
# 如果部分key存在，所有的都不会成功
127.0.0.1:6379> msetnx key6 bb key7 kk
(integer) 0
```

- 设置/获取指定区间的值

```shell
# getrange key start end
127.0.0.1:6379> set key7 "This is a string"
OK
127.0.0.1:6379> get key7
"This is a string"
127.0.0.1:6379> getrange key7 0 3
"This"
127.0.0.1:6379> getrange key7 -3 -1
"ing"

# setrange key offset value
127.0.0.1:6379> setrange key7 10 string10
(integer) 18
127.0.0.1:6379> get key7
"This is a string10"
```

- 数值增减（必须是数字）

```shell
# 必须是数字且必须是整数
127.0.0.1:6379> get key7
"This is a string10"
127.0.0.1:6379> incr key7
(error) ERR value is not an integer or out of range
# 自增1
127.0.0.1:6379> set key8 0
OK
127.0.0.1:6379> incr key8
(integer) 1
127.0.0.1:6379> get key8
"1"
# 按指定数字自增
127.0.0.1:6379> incrby key8 2
(integer) 3
127.0.0.1:6379> incrby key8 2
(integer) 5
127.0.0.1:6379> incrby key8 2
(integer) 7
# 自减1
127.0.0.1:6379> decr key8
(integer) 6
# 按指定数字自减
127.0.0.1:6379> decrby key8 3
(integer) 2
127.0.0.1:6379> decrby key8 3
(integer) -1
```

- 获取字符串长度，内容追加

```shell
127.0.0.1:6379> get key7
"This is a string10"
# 统计string的长度
127.0.0.1:6379> strlen key7
(integer) 18
# 追加内容
127.0.0.1:6379> append key7 " append string"
(integer) 32
127.0.0.1:6379> get key7
"This is a string10 append string"
```

- 分布式锁

当多个客户端竞争同一个资源时，根据redis的setnx先获取锁（原子）再获取资源。

```shell
# 加锁成功访问资源
127.0.0.1:6379> set lock pay ex 10 nx
OK
# 加锁失败等待
127.0.0.1:6379> set lock pay ex 10 nx
(nil)
# 加锁成功
127.0.0.1:6379> set lock pay ex 10 nx
OK
# setex:设置带过期时间的key，动态设置 等同于 set key value ex 10
# setnx:只有在 key 不存在时设置 key 的值 等同于 set key value nx
```

* getset

```shell
127.0.0.1:6379> getset key7 "reset string"
"This is a string10 append string"
127.0.0.1:6379> get key7
"reset string"
```

**运用场景**

- 抖音直播无限点赞，点一次加一次

```shell
127.0.0.1:6379> incr like
(integer) 1
127.0.0.1:6379> incr like
(integer) 2
```


