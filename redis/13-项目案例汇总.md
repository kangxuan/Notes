# 统计页面的UV/PV/DAU/MAU

**术语解释**

- UV（unique visitor），独立访客，一般理解为独立IP，需要考虑去重。

- PV（page view），页面浏览量。

- DAU（Daily Active User），日活用户量，登录或使用了某个产品的用户数，需要考虑去重。

- MAU（Monthly Active User），月活用户量。

**解决方案**

- 针对巨量（上千万）的UV，只需要数量不需要具体的用户，且对精准度要求不高。
  
  - 利用HyperLogLog的去重基数且占用资源非常少的优势进行存储

代码实现：

```go
func main() {
    ctx := context.Background()

    rdb := redis.NewClient(&redis.Options{
        Addr:     "localhost:6379",
        Password: "123", // no password set
        DB:       0,     // use default DB
    })

    rand.Seed(time.Now().UnixNano())
    fmt.Println("-----模拟有用户点击首页，每个用户来自不同的IP地址，开始-----")
    for i := 0; i < 100; i++ {
        ip := strconv.Itoa(rand.Intn(999)) + "." + strconv.Itoa(rand.Intn(999)) + "." + strconv.Itoa(rand.Intn(999)) + "." + strconv.Itoa(rand.Intn(999))
        hll := rdb.PFAdd(ctx, "hll", ip)
        fmt.Printf("ip=%s, 该IP访问首页的次数：%d\n", ip, hll.Val())
    }
    fmt.Println("-----模拟有用户点击首页，每个用户来自不同的IP地址，结束-----")
}
```

运行程序：

```shell
go run uv.go
```

查看基数统计：

```shell
127.0.0.1:6379> pfcount hll
(integer) 98 # 存在误差
```

- PV
  
  - 可以通过incr进行自增统计。
  
  - 如果对精准度要求不高也可以通过HyperLogLog。

代码实现：

```go
func main() {
    ctx := context.Background()

    rdb := redis.NewClient(&redis.Options{
        Addr:     "localhost:6379",
        Password: "123", // no password set
        DB:       0,     // use default DB
    })

    // uv
    key := "page:001"
    rdb.Set(ctx, key, 1, -1)

    for i := 0; i < 100; i++ {
        rdb.Incr(ctx, key)
    }

    // 查询uv
    uv := rdb.Get(ctx, key)
    fmt.Printf("uv:%s\n", uv)
}
```

运行程序：

```shell
go run pv.go
uv:get page:001: 101
```

- DAU&MAU，思路和UV差不多，按照具体的日期形成key。

# 经纬度距离计算

附近的酒店推荐

**解决方案**

根据GEO类型将注册的酒店坐标进行存储，实时获取自己的坐标经纬度，计算离自己2km内的酒店

```go
const hotelKey = "hotels"

var rdb *redis.Client

func init() {
	rdb = redis.NewClient(&redis.Options{
		Addr:     "localhost:6379",
		Password: "123", // no password set
		DB:       0,     // use default DB
	})
}

func main() {
	ctx := context.Background()
	// 添加坐标
	geoAdd(ctx, "希尔顿欢朋酒店", 120.122094, 30.345323)
	geoAdd(ctx, "海外海国际酒店", 120.128721, 30.334236)
	// 获取坐标
	pos, _ := geoPos(ctx, "海外海国际酒店")
	fmt.Println(pos)
	// 获取hash
	hashes, _ := geoHash(ctx, "希尔顿欢朋酒店", "海外海国际酒店")
	fmt.Println(hashes)
	// 获取距离
	dist, _ := geoDist(ctx, "希尔顿欢朋酒店", "海外海国际酒店")
	fmt.Println(dist)
	// 获取就近的酒店
	locations, _ := geoRadius(ctx, 120.120388, 30.341701, 2)
	fmt.Println(locations)
}

// geoAdd 添加坐标
func geoAdd(ctx context.Context, hotelName string, lon float64, lat float64) bool {
	rdb.GeoAdd(ctx, hotelKey, &redis.GeoLocation{Longitude: lon, Latitude: lat, Name: hotelName})
	return true
}

// geoPos 获取坐标
func geoPos(ctx context.Context, hotelName string) ([]*redis.GeoPos, error) {
	pos, err := rdb.GeoPos(ctx, hotelKey, hotelName).Result()
	if err != nil {
		return nil, err
	}
	return pos, nil
}

// geoHash 获取hash
func geoHash(ctx context.Context, hotelNames ...string) ([]string, error) {
	hashes, err := rdb.GeoHash(ctx, hotelKey, hotelNames...).Result()
	if err != nil {
		return nil, err
	}
	return hashes, nil
}

// geoDist 获取距离
func geoDist(ctx context.Context, hotelName1 string, hotelName2 string) (float64, error) {
	dist, err := rdb.GeoDist(ctx, hotelKey, hotelName1, hotelName2, "km").Result()
	if err != nil {
		return 0, err
	}
	return dist, nil
}

// geoRadius 根据距离获取坐标
func geoRadius(ctx context.Context, lon float64, lat float64, radius float64) ([]redis.GeoLocation, error) {
	locations, err := rdb.GeoRadius(ctx, hotelKey, lon, lat, &redis.GeoRadiusQuery{
		Radius: radius,
		Unit:   "km",
	}).Result()
	if err != nil {
		return nil, err
	}
	return locations, nil
}
```

执行程序：

```shell
go run geo.go 
[0xc0000aa080]
[wtmktknnrd0 wtmktd5jdp0]
1.3875
[{希尔顿欢朋酒店 0 0 0 0} {海外海国际酒店 0 0 0 0}]
```
