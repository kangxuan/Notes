# 统计页面的UV/PV/DAU/MAU

**术语解释**

- UV（unique visitor），独立访客，一般理解为独立IP，需要考虑去重。

- PV（page view），页面浏览量。

- DAU（Daily Active User），日活用户量，登录或使用了某个产品的用户数，需要考虑去重。

- MAU（Monthly Active User），月活用户量。

**解决方案**

- 针对巨量（上千万）的UV，只需要数量不需要具体的用户，且对精准度要求不高。
  
  - 利用HyperLogLog的去重基数且占用资源非常少的优势进行存储

代码实现：

```go
func main() {
	ctx := context.Background()

	rdb := redis.NewClient(&redis.Options{
		Addr:     "localhost:6379",
		Password: "123", // no password set
		DB:       0,     // use default DB
	})

	rand.Seed(time.Now().UnixNano())
	fmt.Println("-----模拟有用户点击首页，每个用户来自不同的IP地址，开始-----")
	for i := 0; i < 100; i++ {
		ip := strconv.Itoa(rand.Intn(999)) + "." + strconv.Itoa(rand.Intn(999)) + "." + strconv.Itoa(rand.Intn(999)) + "." + strconv.Itoa(rand.Intn(999))
		hll := rdb.PFAdd(ctx, "hll", ip)
		fmt.Printf("ip=%s, 该IP访问首页的次数：%d\n", ip, hll.Val())
	}
	fmt.Println("-----模拟有用户点击首页，每个用户来自不同的IP地址，结束-----")
}
```

运行程序：

```shell
go run uv.go
```

查看基数统计：

```shell
127.0.0.1:6379> pfcount hll
(integer) 98 # 存在误差
```

- PV
  
  - 可以通过incr进行自增统计。
  
  - 如果对精准度要求不高也可以通过HyperLogLog。

代码实现：

```go
func main() {
	ctx := context.Background()

	rdb := redis.NewClient(&redis.Options{
		Addr:     "localhost:6379",
		Password: "123", // no password set
		DB:       0,     // use default DB
	})

	// uv
	key := "page:001"
	rdb.Set(ctx, key, 1, -1)

	for i := 0; i < 100; i++ {
		rdb.Incr(ctx, key)
	}

	// 查询uv
	uv := rdb.Get(ctx, key)
	fmt.Printf("uv:%s\n", uv)
}
```

运行程序：

```shell
go run pv.go
uv:get page:001: 101
```

- DAU&MAU，思路和UV差不多，按照具体的日期形成key。
