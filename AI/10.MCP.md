# MCPæ ¸å¿ƒæ¦‚å¿µ

MCPï¼ŒModel Context Protocolï¼Œæ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼Œæ˜¯ç”±Anthropicå…¬å¸åœ¨2024å¹´11æœˆæå‡ºçš„ä¸€ç§å¼€æ”¾åè®®æ ‡å‡†ã€‚ç›®çš„åœ¨äºæ ‡å‡†åŒ–æ¨¡å‹ä¸å¤–éƒ¨æ•°æ®æºã€å·¥å…·ä»¥åŠæœåŠ¡ä¹‹é—´çš„äº¤äº’æ–¹å¼ã€‚

MCPæ˜¯ä¸€ç§åè®®ï¼Œåªè¦éµå¾ªè¿™ç§åè®®å¼€å‘çš„å¤–éƒ¨å·¥å…·éƒ½å¯ä»¥è¢«æ¨¡å‹è°ƒç”¨ã€‚ç±»ä¼¼ä¸USB-Cæ¥å£ã€‚

![MCPåè®®ç¤ºä¾‹å›¾](./images/MCP.png)

### MCPå’ŒFunction Callingå¯¹æ¯”

MCPå’ŒFunction Callingå¾ˆåƒï¼Œéƒ½å¯ä»¥å¢å¼ºå¤§æ¨¡å‹çš„èƒ½åŠ›ã€‚ä½†MCPå’ŒFunction Callingæ˜¯ä¸¤ä¸ªä¸åŒçš„ä¸œè¥¿ã€‚

| ç±»åˆ«    | MCP (Model Context Protocol) | Function Calling     |
| ----- | ---------------------------- | -------------------- |
| æ€§è´¨    | æ˜¯ä¸€ç§åè®®                        | æ˜¯å¼€å‘çš„åŠŸèƒ½æˆ–å‡½æ•°            |
| èŒƒå›´    | é€šç”¨ï¼ˆå¤šæ•°æ®æºã€å¤šåŠŸèƒ½ï¼‰ï¼Œå¯æä¾›ç»™å¤–éƒ¨ä½¿ç”¨        | ç‰¹å®šåœºæ™¯ï¼ˆå•ä¸€æ•°æ®æºæˆ–åŠŸèƒ½ï¼‰ï¼Œä»…è‡ªå·±ä½¿ç”¨ |
| ç›®æ ‡    | ç»Ÿä¸€æ¥å£ï¼Œå®ç°äº’æ“ä½œ                   | æ‰©å±•æ¨¡å‹èƒ½åŠ›               |
| å®ç°    | åŸºäºæ ‡å‡†åè®®                       | ä¾èµ–äºç‰¹å®šæ¨¡å‹å®ç°            |
| å¼€å‘å¤æ‚åº¦ | ä½ï¼šé€šè¿‡ç»Ÿä¸€åè®®å®ç°å¤šæºå…¼å®¹               | é«˜ï¼šéœ€è¦ä¸ºæ¯ä¸ªä»»åŠ¡å•ç‹¬å¼€å‘å‡½æ•°      |
| å¤ç”¨æ€§   | é«˜ï¼šä¸€æ¬¡å¼€å‘ï¼Œå¯å¤šåœºæ™¯ä½¿ç”¨                | ä½ï¼šå‡½æ•°é€šå¸¸ä¸ºç‰¹å®šä»»åŠ¡è®¾è®¡        |
| çµæ´»æ€§   | é«˜ï¼šæ”¯æŒåŠ¨æ€é€‚é…å’Œæ‰©å±•                  | ä½ï¼šåŠŸèƒ½æ‰©å±•éœ€è¦é¢å¤–å¼€å‘         |
| å¸¸è§åœºæ™¯  | å¤æ‚åœºæ™¯ï¼Œå¦‚è·¨å¹³å°æ•°æ®è®¿é—®ä¸æ•´åˆ             | ç®€å•ä»»åŠ¡ï¼Œå¦‚å¤©æ°”æŸ¥è¯¢ã€å•†å“æ¨èç­‰     |

### MCPçš„æ¶æ„

MCPé‡‡ç”¨å®¢æˆ·ç«¯-æœåŠ¡å™¨ï¼ˆClient-Serverï¼‰æ¶æ„ï¼Œä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

##### 1ã€MCP Host

è¿è¡Œå¤§æ¨¡å‹çš„ç¯å¢ƒï¼Œæ¯”å¦‚Cursorã€Treaã€Cherry Studioã€LangChainæ¡†æ¶ã€Qwen Agentç­‰ã€‚

##### 2ã€MCP Client

MCPå®¢æœç«¯ï¼Œæ˜¯åµŒå…¥åˆ°MCP Hostç»„ä»¶ä¸­ï¼Œå®ƒè´Ÿè´£å‘MCP Serverå‘èµ·è¯·æ±‚å¹¶ä¿æŒé€šä¿¡ã€‚

##### 3ã€MCP Server

MCPæœåŠ¡å™¨ï¼Œä¸»è¦ç”¨æ¥ç»™å¤§æ¨¡å‹æä¾›æœåŠ¡çš„ã€‚

### MCPçš„æ ¸å¿ƒåŠŸèƒ½

MCP æä¾›ä¸‰ç§å…³é”®èƒ½åŠ›ï¼š

##### 1ã€çŸ¥è¯†æ‰©å±•

æä¾›ç»“æ„åŒ–æ•°æ®ï¼ˆå¦‚æ•°æ®åº“ã€æ–‡æ¡£ï¼‰ä»¥å¢å¼ºLLMçš„ä¸Šä¸‹æ–‡ç†è§£ã€‚

##### 2ã€å·¥å…·è°ƒç”¨

å…è®¸ AI æ‰§è¡Œå¤–éƒ¨æ“ä½œï¼ˆå¦‚å‘é€é‚®ä»¶ã€æŸ¥è¯¢ GitHubã€è°ƒç”¨æ™ºèƒ½åˆçº¦ç­‰ï¼‰ã€‚

##### 3ã€æç¤ºæ¨¡ç‰ˆ

é¢„å®šä¹‰çš„æŒ‡ä»¤æ¨¡æ¿ï¼Œä¼˜åŒ– AI çš„ä»»åŠ¡æ‰§è¡Œã€‚

### MCPçš„è¿ç”¨åœºæ™¯

##### 1ã€å¢å¼ºLLMçš„å®æ—¶æ€§ä¸æ‰§è¡Œèƒ½åŠ›

**å®æ—¶æ•°æ®è®¿é—®ï¼š** MCP å…è®¸LLMè®¿é—®æœ€æ–°æ•°æ®ï¼ˆå¦‚è‚¡ç¥¨è¡Œæƒ…ã€æ–°é—»ï¼‰ï¼Œè€Œéä»…ä¾èµ–è®­ç»ƒæ—¶çš„é™æ€æ•°æ®ï¼Œç”¨æ¥å¢å¼ºLLMçš„èƒ½åŠ›ã€‚

**è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼š** LLMå¯é€šè¿‡MCPç›´æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æ•´ç†æ–‡ä»¶ã€å‘é€é‚®ä»¶ã€ç®¡ç†ä»£ç ä»“åº“ç­‰ã€‚

**åŒºå—é“¾äº¤äº’ï¼š** MCP å¯é›†æˆä»¥å¤ªåŠæ™ºèƒ½åˆçº¦ï¼Œè®©ç”¨æˆ·é€šè¿‡è‡ªç„¶è¯­è¨€å®Œæˆé“¾ä¸Šæ“ä½œï¼ˆå¦‚ DeFi äº¤æ˜“ï¼‰ã€‚

##### 2ã€å»ä¸­å¿ƒåŒ– AI ç”Ÿæ€

**åˆ›ä½œè€…ç»æµï¼š** ä¸ªäººæˆ–ä¼ä¸šå¯æ­å»ºMCP Serveræä¾›ç‰¹å®šæœåŠ¡ï¼ˆå¦‚é¸Ÿç±»çŸ¥è¯†åº“ï¼‰ï¼Œå¹¶é€šè¿‡è°ƒç”¨æ¬¡æ•°è·å¾—æ”¶ç›Šã€‚

**æŠ—å®¡æŸ¥ä¸å»ä¸­å¿ƒåŒ–ï¼š** MCP ä½¿ AI èƒ½åŠ›åˆ†æ•£åœ¨å¤šä¸ª Server ä¸Šï¼Œå‡å°‘å¤§å…¬å¸å„æ–­é£é™©ã€‚

##### 3ã€å¼€å‘è€…å·¥å…·

**ç®€åŒ–é›†æˆï¼š** MCP æ ‡å‡†åŒ–äº† AI ä¸å¤–éƒ¨ç³»ç»Ÿçš„äº¤äº’ï¼Œå¼€å‘è€…æ— éœ€ä¸ºæ¯ä¸ªæ•°æ®æºç¼–å†™å®šåˆ¶ APIã€‚

**å¤šæ¨¡æ€æ”¯æŒï¼š** MCP å¯æ•´åˆè¯­éŸ³ã€å›¾åƒã€ä¼ æ„Ÿå™¨æ•°æ®ç­‰ï¼Œä½¿ AI å…·å¤‡æ›´å…¨é¢çš„ç¯å¢ƒæ„ŸçŸ¥èƒ½åŠ›

# MCPä½¿ç”¨

### Qwen Agentä¸­ä½¿ç”¨MCP

åœ¨9.FunctionCall.mdä¸­é—¨ç¥¨åŠ©æ‰‹ä¸­å¢åŠ MCPæ³¨å†Œï¼Œåªéœ€è¦å†function_listæ·»åŠ MCPé…ç½®å³å¯ï¼š

```python
# ............ çœç•¥ä»£ç 

# ====== åˆå§‹åŒ–é—¨ç¥¨åŠ©æ‰‹æœåŠ¡ ======
def init_agent_service():
    """åˆå§‹åŒ–é—¨ç¥¨åŠ©æ‰‹æœåŠ¡"""
    llm_cfg = {
        'model': 'qwen-turbo-2025-04-28',
        'timeout': 30,
        'retry_count': 3,
    }
    try:
        bot = Assistant(
            llm=llm_cfg,
            name='é—¨ç¥¨åŠ©æ‰‹',
            description='é—¨ç¥¨æŸ¥è¯¢ä¸è®¢å•åˆ†æ',
            system_message=system_prompt,
            function_list=[
                # MCP é…ç½®
                {
                    "mcpServers": {
                        "amap-maps": {
                            "command": "npx",
                            "args": [
                                "-y",
                                "@amap/amap-maps-mcp-server"
                            ],
                            "env": {
                                "AMAP_MAPS_API_KEY": "ä½ çš„é«˜å¾·API KEY"
                            }
                        }
                    }
                },
                'exc_sql'
            ],
        )
        print("åŠ©æ‰‹åˆå§‹åŒ–æˆåŠŸï¼")
        return bot
    except Exception as e:
        print(f"åŠ©æ‰‹åˆå§‹åŒ–å¤±è´¥: {str(e)}")
        raise

# ............ çœç•¥ä»£ç 

if __name__ == '__main__':
    # è¿è¡Œæ¨¡å¼é€‰æ‹©
    app_gui()          # å›¾å½¢ç•Œé¢æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
```

è¿è¡Œç»“æœï¼š

```shell
python assistant_ticket_bot.py
æ­£åœ¨å¯åŠ¨ Web ç•Œé¢...
# è¿™é‡Œå¯ä»¥çœ‹åˆ°æ­£åœ¨åˆå§‹é…ç½®çš„MCP
2025-12-25 22:42:56,468 - mcp_manager.py - 141 - INFO - Initializing MCP tools from mcp servers: ['amap-maps']
2025-12-25 22:42:56,482 - mcp_manager.py - 370 - INFO - Initializing a MCP stdio_client, if this takes forever, please check the config of this mcp server: amap-maps
Amap Maps MCP Server running on stdio
åŠ©æ‰‹åˆå§‹åŒ–æˆåŠŸï¼
Web ç•Œé¢å‡†å¤‡å°±ç»ªï¼Œæ­£åœ¨å¯åŠ¨æœåŠ¡...
* Running on local URL:  http://127.0.0.1:7860

To create a public link, set `share=True` in `launch()`.
```

è®¿é—®ç½‘å€ï¼š

![Qwen-Agent-MCPå›¾ç‰‡](./images/Qwen-Agent-MCP.png)

å¯ä»¥çœ‹åˆ°MCPçš„å·¥å…·å·²ç»è¢«æ³¨å†Œè¿›å»äº†ï¼Œç°åœ¨æˆ‘ä»¬æé—®å°±å¯ä»¥ä½¿ç”¨MCPäº†ã€‚

![Qwen-Agent-MCP1å›¾ç‰‡](./images/Qwen-Agent-MCP1.png)

# æ­å»ºMCP Server

æ­å»ºMCP Serverå¯ä»¥æä¾›æ ‡å‡†åŒ–çš„APIï¼Œä¾›LLMè°ƒç”¨å¤–éƒ¨åŠŸèƒ½ï¼Œä»¥æ­¤æ¥å¢å¼ºèƒ½åŠ›ã€‚ä¸»è¦é€šè¿‡`@mcp.tool()`è£…é¥°å™¨å°†pythonå‡½æ•°æš´éœ²ç»™LLMä½¿ç”¨ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒæƒé™æ§åˆ¶ï¼Œç¡®ä¿LLMä¸ä¼šè¶Šæƒè®¿é—®æ•æ„Ÿæ•°æ®ã€‚

### å®‰è£…MCP

```shell
pip install mcp
```

### FastMCP

FastMCPæ˜¯Python MCP SDKä¸­è½»é‡çº§æ¡†æ¶ï¼Œä¸»è¦æœ‰ä¸‹é¢å‡ ä¸ªç‰¹ç‚¹ï¼š

1. **è½»é‡æ˜“ç”¨ï¼š** ä»…éœ€å‡ è¡Œä»£ç å°±å¯ä»¥å¯åŠ¨MCP Serverã€‚

2. **æ”¯æŒå¤šç§ä¼ è¾“æ–¹å¼ï¼š** å¦‚stdioï¼ˆæ ‡å‡†è¾“å…¥è¾“å‡ºï¼‰ï¼ŒHTTPç­‰ã€‚

3. **è‡ªåŠ¨å‘ç°å·¥å…·ï¼š** é€šè¿‡`@mcp.tool()`æ³¨è§£è‡ªåŠ¨æ³¨å†Œå‡½æ•°ï¼Œä¾›LLMè°ƒç”¨ã€‚

### ä¾‹å­ï¼š

##### 1ã€ä½¿ç”¨FastMCPæ­å»ºæ¡Œé¢TXTç»Ÿè®¡å™¨MCP Server

é¦–å…ˆæ­å»ºæ¡Œé¢txtç»Ÿè®¡å™¨MCP Serverï¼š

1. åˆ›å»ºFastMCPå®ä¾‹

2. å®šä¹‰mcpçš„æ–¹æ³•ï¼Œé€šè¿‡@mcp.tool

3. è¿è¡Œmcpå®ä¾‹

```python
import os
from pathlib import Path
from mcp.server.fastmcp import FastMCP

# åˆ›å»º MCP Server
mcp = FastMCP("æ¡Œé¢ TXT æ–‡ä»¶ç»Ÿè®¡å™¨")

# å®šä¹‰mcpçš„tool
@mcp.tool()
def count_desktop_txt_files() -> int:
    """ç»Ÿè®¡æ¡Œé¢ä¸Š .txt æ–‡ä»¶çš„æ•°é‡"""
    # è·å–æ¡Œé¢è·¯å¾„
    desktop_path = Path(os.path.expanduser("~/Desktop"))

    # ç»Ÿè®¡ .txt æ–‡ä»¶
    txt_files = list(desktop_path.glob("*.txt"))
    return len(txt_files)

@mcp.tool()
def list_desktop_txt_files() -> str:
    """è·å–æ¡Œé¢ä¸Šæ‰€æœ‰ .txt æ–‡ä»¶çš„åˆ—è¡¨"""
    # è·å–æ¡Œé¢è·¯å¾„
    desktop_path = Path(os.path.expanduser("~/Desktop"))

    # è·å–æ‰€æœ‰ .txt æ–‡ä»¶
    txt_files = list(desktop_path.glob("*.txt"))

    # è¿”å›æ–‡ä»¶ååˆ—è¡¨
    if not txt_files:
        return "æ¡Œé¢ä¸Šæ²¡æœ‰æ‰¾åˆ° .txt æ–‡ä»¶ã€‚"

    # æ ¼å¼åŒ–æ–‡ä»¶ååˆ—è¡¨
    file_list = "\n".join([f"- {file.name}" for file in txt_files])
    return f"åœ¨æ¡Œé¢ä¸Šæ‰¾åˆ° {len(txt_files)} ä¸ª .txt æ–‡ä»¶ï¼š\n{file_list}"

@mcp.tool()
def read_txt_file(filename: str) -> str:
    """è¯»å–æŒ‡å®štxtæ–‡ä»¶çš„å†…å®¹
    
    Args:
        filename: txtæ–‡ä»¶çš„åç§°ï¼ˆä¾‹å¦‚ï¼štest.txtï¼‰
        
    Returns:
        æ–‡ä»¶å†…å®¹ï¼Œå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™è¿”å›é”™è¯¯ä¿¡æ¯
    """
    # è·å–æ¡Œé¢è·¯å¾„
    desktop_path = Path(os.path.expanduser("~/Desktop"))
    file_path = desktop_path / filename
    
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if not file_path.exists():
        return f"é”™è¯¯ï¼šæ–‡ä»¶ '{filename}' ä¸å­˜åœ¨äºæ¡Œé¢ä¸Šã€‚"
    
    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æ˜¯txtæ–‡ä»¶
    if file_path.suffix.lower() != '.txt':
        return f"é”™è¯¯ï¼šæ–‡ä»¶ '{filename}' ä¸æ˜¯txtæ–‡ä»¶ã€‚"
    
    try:
        # è¯»å–æ–‡ä»¶å†…å®¹
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        return f"æ–‡ä»¶ '{filename}' çš„å†…å®¹ï¼š\n\n{content}"
    except Exception as e:
        return f"è¯»å–æ–‡ä»¶æ—¶å‘ç”Ÿé”™è¯¯ï¼š{str(e)}"

if __name__ == "__main__":
   # è¿è¡Œmcp
    mcp.run()
```

å¯åŠ¨mcpï¼š

```shell
$ mcp dev txt_counter.py
Starting MCP inspector...
âš™ï¸ Proxy server listening on localhost:6277
ğŸ”‘ Session token: 6bc20d3f7e47dd17036e23a568944d3ac67531f48dd073086d49fdf597e588c1
   Use this token to authenticate requests or set DANGEROUSLY_OMIT_AUTH=true to disable auth

ğŸš€ MCP Inspector is up and running at:
   http://localhost:6274/?MCP_PROXY_AUTH_TOKEN=6bc20d3f7e47dd17036e23a568944d3ac67531f48dd073086d49fdf597e588c1

ğŸŒ Opening browser...
```

è°ƒç”¨mcpï¼š

```python
import os
import dashscope
from qwen_agent.agents import Assistant
from qwen_agent.gui import WebUI


dashscope.api_key = os.getenv('DASHSCOPE_API_KEY', '')  # ä»ç¯å¢ƒå˜é‡è·å– API Key

def init_agent_service():
    """åˆå§‹åŒ–æ–‡æœ¬è®¡æ•°åŠ©æ‰‹æœåŠ¡
    
    é…ç½®è¯´æ˜ï¼š
    - ä½¿ç”¨ qwen-flash-2025-04-28 ä½œä¸ºåº•å±‚è¯­è¨€æ¨¡å‹
    - è®¾ç½®ç³»ç»Ÿè§’è‰²ä¸ºæ–‡æœ¬åˆ†æåŠ©æ‰‹
    - é…ç½®æ–‡æœ¬è®¡æ•° MCP å·¥å…·
    
    Returns:
        Assistant: é…ç½®å¥½çš„æ–‡æœ¬è®¡æ•°åŠ©æ‰‹å®ä¾‹
    """

    llm_cfg = {
        'model': 'qwen-plus',  # ä½¿ç”¨æœ‰æ•ˆçš„é€šä¹‰åƒé—®æ¨¡å‹åç§°
        'timeout': 30,
        'retry_count': 3,
    }

     # ç³»ç»Ÿè§’è‰²è®¾å®š
    system = ('ä½ æ‰®æ¼”ä¸€ä¸ªæ–‡æœ¬åˆ†æåŠ©æ‰‹ï¼Œä½ å…·æœ‰è®¡ç®—æ–‡æœ¬å­—ç¬¦æ•°ã€å•è¯æ•°ã€è¡Œæ•°ç­‰èƒ½åŠ›ã€‚'
             'ä½ å¯ä»¥å¸®åŠ©ç”¨æˆ·åˆ†ææ–‡æœ¬çš„åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ã€‚'
             'ä½ åº”è¯¥å……åˆ†åˆ©ç”¨æ–‡æœ¬è®¡æ•°æœåŠ¡çš„åŠŸèƒ½æ¥æä¾›ä¸“ä¸šçš„åˆ†æã€‚')

    # MCP å·¥å…·é…ç½®
    tools = [{
        "mcpServers": {
            "txt-counter": {
                "command": "/usr/local/bin/python3.11",  # æ˜ç¡®æŒ‡å®šPython 3.11çš„å®Œæ•´è·¯å¾„
                "args": ["-u", "txt_counter.py"],  # ä½¿ç”¨-uå‚æ•°ç¡®ä¿å®æ—¶è¾“å‡º
                "port": 6277,
                "stdio": True,  # ä½¿ç”¨stdioæ¨¡å¼è€Œä¸æ˜¯HTTP
                "use_uv": False  # æ˜ç¡®ç¦ç”¨uv
            }
        }
    }]

    try:
        # åˆ›å»ºåŠ©æ‰‹å®ä¾‹
        bot = Assistant(
            llm=llm_cfg,
            name='æ–‡æœ¬è®¡æ•°åŠ©æ‰‹',
            description='æ–‡æœ¬ç»Ÿè®¡ä¸åˆ†æ',
            system_message=system,
            function_list=tools,
        )
        print("åŠ©æ‰‹åˆå§‹åŒ–æˆåŠŸï¼")
        return bot
    except Exception as e:
        print(f"åŠ©æ‰‹åˆå§‹åŒ–å¤±è´¥: {str(e)}")
        raise

def app_gui():
    """å›¾å½¢ç•Œé¢æ¨¡å¼
    
    æä¾› Web å›¾å½¢ç•Œé¢ï¼Œç‰¹ç‚¹ï¼š
    - å‹å¥½çš„ç”¨æˆ·ç•Œé¢
    - é¢„è®¾æŸ¥è¯¢å»ºè®®
    - æ™ºèƒ½æ–‡æœ¬åˆ†æ
    """
    try:
        print("æ­£åœ¨å¯åŠ¨ Web ç•Œé¢...")
        # åˆå§‹åŒ–åŠ©æ‰‹
        bot = init_agent_service()
        # é…ç½®èŠå¤©ç•Œé¢
        chatbot_config = {
            'prompt.suggestions': [
                'å¸®æˆ‘ç»Ÿè®¡æ¡Œé¢ä¸Šçš„txtæ–‡ä»¶',
            ]
        }
        
        print("Web ç•Œé¢å‡†å¤‡å°±ç»ªï¼Œæ­£åœ¨å¯åŠ¨æœåŠ¡...")
        # å¯åŠ¨ Web ç•Œé¢
        WebUI(
            bot,
            chatbot_config=chatbot_config
        ).run()
    except Exception as e:
        print(f"å¯åŠ¨ Web ç•Œé¢å¤±è´¥: {str(e)}")
        print("è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œ API Key é…ç½®")

if __name__ == '__main__':
    app_gui()
```

è¿è¡Œï¼š

```shell
$ python assistant_desktop_txt_bot.py
æ­£åœ¨å¯åŠ¨ Web ç•Œé¢...
2025-12-31 21:40:04,587 - mcp_manager.py - 141 - INFO - Initializing MCP tools from mcp servers: ['txt-counter']
2025-12-31 21:40:04,599 - mcp_manager.py - 370 - INFO - Initializing a MCP stdio_client, if this takes forever, please check the config of this mcp server: txt-counter
[12/31/25 21:40:05] INFO     Processing request of type ListToolsRequest                   server.py:624
                    INFO     Processing request of type ListResourcesRequest               server.py:624
åŠ©æ‰‹åˆå§‹åŒ–æˆåŠŸï¼
Web ç•Œé¢å‡†å¤‡å°±ç»ªï¼Œæ­£åœ¨å¯åŠ¨æœåŠ¡...
* Running on local URL:  http://127.0.0.1:7860

To create a public link, set `share=True` in `launch()`.
```

è®¿é—®[http://127.0.0.1:7860](http://127.0.0.1:7860)

![MCP-Serverå›¾ç‰‡](./images/MCP-Server.png)

# Agent2Agentæ¦‚å¿µ

Agent2Agentï¼ˆA2Aï¼‰åè®®æ˜¯googleå…¬å¸åœ¨2025å¹´4æœˆæå‡ºçš„å¼€æ”¾åè®®ã€‚ç›®çš„æ˜¯ä¿ƒè¿›AI Agentä¹‹é—´çš„åè®®ï¼Œé€‚ç”¨äºå¤§è§„æ¨¡ã€å¤šæ™ºèƒ½ä½“çš„éƒ¨ç½²ã€‚

### A2AåŸºäºäº”å¤§æ ¸å¿ƒåŸåˆ™ï¼š

1. **æ‹¥æŠ±æ™ºèƒ½ä½“èƒ½åŠ›ï¼š** æ”¯æŒè‡ªç„¶ã€éç»“æ„åŒ–çš„åä½œæ¨¡å¼

2. **åˆ©ç”¨ç°æœ‰æ ‡å‡†ï¼š** ä½¿ç”¨HTTPã€SSEã€JSON-RPCï¼Œç¡®ä¿ä¸ç°æœ‰ç³»ç»Ÿå…¼å®¹

3. **é»˜è®¤å®‰å…¨ï¼š** æ”¯æŒä¼ä¸šçº§è®¤è¯å’Œæˆæƒï¼Œå¯åŠ¨æ—¶ä¸ OpenAPI ä¿æŒä¸€è‡´ã€‚

4. **æ”¯æŒé•¿æœŸä»»åŠ¡ï¼š** å¤„ç†ä»å¿«é€Ÿä»»åŠ¡åˆ°æ·±å…¥ç ”ç©¶çš„ä»»åŠ¡ï¼Œæä¾›å®æ—¶åé¦ˆã€é€šçŸ¥å’ŒçŠ¶æ€æ›´æ–°ã€‚

5. **å¤šæ¨¡æ€æ”¯æŒï¼š** æ”¯æŒæ–‡æœ¬ã€éŸ³é¢‘ã€è§†é¢‘æµç­‰å¤šæ¨¡æ€é€šä¿¡ã€‚

### A2Aç»„æˆï¼š

1. **Agent Cardï¼š** å…¬å…±å…ƒæ•°æ®æ–‡ä»¶ï¼Œä½äº /.well-known/agent.jsonï¼Œæè¿°æ™ºèƒ½ä½“çš„èƒ½åŠ›ã€æŠ€èƒ½ã€ç«¯ç‚¹ URL å’Œè®¤è¯è¦æ±‚ï¼Œç”¨äºèƒ½åŠ›å‘ç°ã€‚

2. **A2A æœåŠ¡å™¨ï¼š** æš´éœ² HTTP ç«¯ç‚¹ï¼Œå®ç° A2A åè®®æ–¹æ³•ï¼Œç®¡ç†ä»»åŠ¡æ‰§è¡Œã€‚

3. **A2A å®¢æˆ·ç«¯ï¼š** åº”ç”¨ç¨‹åºæˆ–æ™ºèƒ½ä½“ï¼Œæ¶ˆè´¹ A2A æœåŠ¡ï¼Œé€šè¿‡å‘é€ tasks/send æˆ– tasks/sendSubscribe è¯·æ±‚ä¸æœåŠ¡å™¨äº¤äº’

### A2Aå·¥ä½œæµï¼š

1. **å‘ç°ï¼š** å®¢æˆ·ç«¯ä» /.well-known/agent.json è·å– Agent Cardï¼Œäº†è§£æ™ºèƒ½ä½“èƒ½åŠ›

2. **å¯åŠ¨ï¼š** å®¢æˆ·ç«¯å‘é€ä»»åŠ¡è¯·æ±‚ï¼š
   
   1. ä½¿ç”¨ tasks/send å¤„ç†å³æ—¶ä»»åŠ¡ï¼Œè¿”å›æœ€ç»ˆ Task å¯¹è±¡ã€‚
   
   2. ä½¿ç”¨ tasks/sendSubscribe å¤„ç†é•¿æœŸä»»åŠ¡ï¼ŒæœåŠ¡å™¨é€šè¿‡ SSE äº‹ä»¶å‘é€æ›´æ–°ã€‚

3. **å¤„ç†ï¼š** æœåŠ¡å™¨å¤„ç†ä»»åŠ¡ï¼Œå¯èƒ½æ¶‰åŠæµå¼æ›´æ–°æˆ–ç›´æ¥è¿”å›ç»“æœã€‚

4. **äº¤äº’ï¼ˆå¯é€‰ï¼‰ï¼š** è‹¥ä»»åŠ¡çŠ¶æ€ä¸º input-requiredï¼Œå®¢æˆ·ç«¯å¯å‘é€æ›´å¤šæ¶ˆæ¯ï¼Œä½¿ç”¨ç›¸åŒ Task ID æä¾›è¾“å…¥ã€‚

5. **å®Œæˆï¼š** ä»»åŠ¡è¾¾åˆ°ç»ˆç«¯çŠ¶æ€ï¼ˆå¦‚ completedã€failed æˆ– canceledï¼‰ã€‚

### A2Aå’ŒMCPçš„åŒºåˆ«å’Œå…³ç³»

##### åŒºåˆ«ï¼š

MCPæ˜¯æ¨¡å‹ä¸Šä¸‹æ–‡åè®®ï¼Œä¸»è¦ç”¨æ¥æä¾›å·¥å…·å’Œèµ„æºã€‚è€ŒA2Aä¸»è¦æ˜¯ç”¨æ¥Agentä¹‹é—´çš„åä½œã€‚

##### è”ç³»ï¼š

ä¸€ä¸ªAgentå¯èƒ½å…ˆä»MCPæœåŠ¡å™¨è·å¾—æ•°æ®ï¼Œç„¶åé€šè¿‡A2Aåè®®ä¸å¦ä¸€ä¸ªAgentåä½œåˆ†ææ•°æ®ã€‚

![A2Aä¸MCPçš„å…³ç³»å›¾](./images/A2Aä¸MCPå…³ç³».png)

### ä¾‹å­ï¼š

##### 1ã€å®‰æ’ç¯®çƒæ´»åŠ¨

ç¯®çƒæ´»åŠ¨æ™ºèƒ½ä½“é€šè¿‡A2Aåè®®è°ƒç”¨å¤©æ°”æ™ºèƒ½ä½“ï¼Œé€šè¿‡å¾—åˆ°å¤©æ°”åå†³ç­–æ˜¯å¦å®‰æ’ç¯®çƒæ´»åŠ¨ã€‚

å®šä¹‰WetherAgentï¼š

```python
from fastapi import FastAPI, HTTPException
from datetime import date
from pydantic import BaseModel
import uvicorn

app = FastAPI()

# Agent Cardå£°æ˜ï¼ˆé€šè¿‡/.well-known/agent.jsonæš´éœ²ï¼‰
WEATHER_AGENT_CARD = {
    "name": "WeatherAgent",
    "version": "1.0",
    "description": "æä¾›æŒ‡å®šæ—¥æœŸçš„å¤©æ°”æ•°æ®æŸ¥è¯¢",
    "endpoints": {
        "task_submit": "/api/tasks/weather",
        "sse_subscribe": "/api/tasks/updates"
    },
    "input_schema": {
        "type": "object",
        "properties": {
            "date": {"type": "string", "format": "date"},
            "location": {"type": "string", "enum": ["åŒ—äº¬"]}
        },
        "required": ["date"]
    },
    "authentication": {"methods": ["API_Key"]}
}

# ä»»åŠ¡è¯·æ±‚æ¨¡å‹
class WeatherTaskRequest(BaseModel):
    task_id: str
    params: dict

# æ¨¡æ‹Ÿå¤©æ°”æ•°æ®å­˜å‚¨
weather_db = {
    "2025-05-08": {"temperature": "25â„ƒ", "condition": "é›·é˜µé›¨"},
    "2025-05-09": {"temperature": "18â„ƒ", "condition": "å°é›¨è½¬æ™´"},
    "2025-05-10": {"temperature": "22â„ƒ", "condition": "å¤šäº‘è½¬æ™´"}
}

@app.get("/.well-known/agent.json")
async def get_agent_card():
    return WEATHER_AGENT_CARD

@app.post("/api/tasks/weather")
async def handle_weather_task(request: WeatherTaskRequest):
    """å¤„ç†å¤©æ°”æŸ¥è¯¢ä»»åŠ¡"""
    target_date = request.params.get("date")
    # å‚æ•°éªŒè¯
    if not target_date or target_date not in weather_db:
        raise HTTPException(status_code=400, detail="æ— æ•ˆæ—¥æœŸå‚æ•°")
    return {
        "task_id": request.task_id,
        "status": "completed",
        "artifact": {
            "date": target_date,
            "weather": weather_db[target_date]
        }
    }

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)

```

å¯åŠ¨WetherAgentï¼š

```python
$ python WetherAgent.py
```

å®šä¹‰BasketBallAgentï¼š

```python
import requests
import uuid

class BasketBallAgent:
    def __init__(self):
        self.weather_agent_url = "http://localhost:8000"
        self.api_key = "SECRET_KEY"  # å®é™…åº”é€šè¿‡å®‰å…¨æ–¹å¼å­˜å‚¨

    def _create_task(self, target_date: str) -> dict:
        """åˆ›å»ºA2Aæ ‡å‡†ä»»åŠ¡å¯¹è±¡"""
        return {
            "task_id": str(uuid.uuid4()),
            "params": {
                "date": target_date,
                "location": "åŒ—äº¬"
            }
        }

    def check_weather(self, target_date: str) -> dict:
        """é€šè¿‡A2Aåè®®æŸ¥è¯¢å¤©æ°”"""
        # è·å–å¤©æ°”æ™ºèƒ½ä½“èƒ½åŠ›æè¿°
        agent_card = requests.get(
            f"{self.weather_agent_url}/.well-known/agent.json"
        ).json()
        # æ„é€ ä»»åŠ¡è¯·æ±‚
        task = self._create_task(target_date)
        # å‘é€ä»»åŠ¡è¯·æ±‚
        response = requests.post(
            f"{self.weather_agent_url}{agent_card['endpoints']['task_submit']}",
            json=task,
            headers={"Authorization": f"Bearer {self.api_key}"}
        )
        if response.status_code == 200:
            return response.json()["artifact"]
        else:
            raise Exception(f"å¤©æ°”æŸ¥è¯¢å¤±è´¥: {response.text}")

    def schedule_meeting(self, date: str):
        """ç»¼åˆå†³ç­–é€»è¾‘"""
        try:
            result = self.check_weather(date)
            # è¿™é‡Œå¯ä»¥å®ç°æ›´å¤šçš„ä¸šåŠ¡
            if "é›¨" not in result["weather"]["condition"] and "é›ª" not in result["weather"]["condition"]:
                return {"status": "confirmed", "weather": result["weather"]}
            else:
                return {"status": "cancelled", "reason": "æ¶åŠ£å¤©æ°”"}
        except Exception as e:
            return {"status": "error", "detail": str(e)}

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    meeting_agent = BasketBallAgent()
    # result = meeting_agent.schedule_meeting("2025-05-08")
    result = meeting_agent.schedule_meeting("2025-05-10")
    print("ç¯®çƒå®‰æ’ç»“æœ:", result)

```

è¿è¡ŒBasketBallAgentï¼š

```shell

```




